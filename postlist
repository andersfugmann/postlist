#!/bin/bash
set -e
export PATH=${PATH}:/usr/bin:/usr/sbin

### Init file reader
trim()
{
    local trimmed="$@"

    # Strip leading space.
    trimmed="${trimmed## }"
    # Strip trailing space.
    trimmed="${trimmed%% }"

    echo "$trimmed"
}


function parseIniFile() { #accepts the name of the file to parse as argument ($1)
    #declare syntax below (-gA) only works with bash 4.2 and higher
    unset CONFIG
    declare -gA CONFIG
    currentSection=""
    while read -r line; do
        if [[ $line = \[*  ]]; then
            currentSection=$(echo $line | tr -d "[]")
        elif [[ $line = *=*  ]]; then
            key=$(trim $currentSection.$(echo $line | cut -d'=' -f1))
            value="$(trim $(echo $line | cut -d'=' -f2))"
            CONFIG[$key]="$value"
        fi
    done < <(sed 's/#.*//' $1)
}

CONFIG_FILE=${CONFIG_FILE-/etc/postlist.conf}
if [ -f /etc/default/postlist ]; then
    source /etc/default/postlist
fi
echo Parse ${CONFIG_FILE}
parseIniFile ${CONFIG_FILE}

BOUNCE="${CONFIG[general.bounce]}"
ADMIN="${CONFIG[general.owner]}"
LIB_DIR="${CONFIG[general.archive_dir]}"
ALIAS_FILE="${CONFIG[general.alias_file]}"

SENDMAIL="/usr/sbin/sendmail -G -i" # NEVER NEVER NEVER use "-t" here.
# Exit codes from <sysexits.h>
EX_TEMPFAIL=75
EX_UNAVAILABLE=69

function handle_mail () {
    LIST=$1
    ADDRESS="${CONFIG[${LIST}.address]}"
    SUBSCRIBERS="${CONFIG[${LIST}.subscribers]}"
    DESCRIPTION="${CONFIG[${LIST}.description]}"

    MAIL=${LIB_DIR}/$LIST/new/$(date -Ins)
    cat >${MAIL} || (echo Cannot save mail to file; exit $EX_TEMPFAIL)

    if formail -z -x 'X-Loop:' | grep -q ${ID}; then
        SUBJECT=$(formail -x Subject: < ${MAIL})
        cat ${MAIL} \
            | formail -t -f \
	              -I "List-Id: ${DESCRIPTION} <$ADDRESS>" \
	              -I "To:${ID} <${ADMIN}>" \
	              -I "DKIM-Signature:" \
	              -i "Subject:[$ID Bounce] ${SUBJECT}" \
            | ${SENDMAIL} ${ADMIN}
    else
        SENDER=$(formail -z -x 'From:' < ${MAIL} | sed 's/</(/g' | sed 's/>/)/g')
        cat ${MAIL} \
            | formail -t -f \
	              -I "Return-Path:" \
	              -i "From: [${ID}] ${SENDER} <${ADDRESS}>" \
      	              -I "To:${ID} <${ADDRESS}>" \
	              -I "X-Loop: ${ID}" \
	              -I "List-Id: ${DESCRIPTION} <$ADDRESS>" \
	              -I "DKIM-Signature:" \
                      -I "Message-ID:" -a "Message-ID:" \
            | ${SENDMAIL} -f ${BOUNCE} ${SUBSCRIBERS}
    fi
    mv $MAIL $(dirname ${MAIL}/../archive)
}

## Setup all lists.

function setup () {
    echo -n "Setup lists:"
    SCRIPT=$(readlink -f $0)
    # Create all directories, and create the alias file
    LISTS="$(cat $CONFIG_FILE | grep "^\[.*\]" | sed 's/[\[\]]//g' | tr -d "[]" | grep -v 'general')"
    echo "# Autogenerated file. Do not edit" > ${ALIAS_FILE}
    echo "# Generated $(date) by ${SCRIPT}" >> ${ALIAS_FILE}

    for LIST in ${LISTS}; do
        echo -n "$LIST "
        ADDRESS="${CONFIG[${LIST}.address]}"
        SUBSCRIBERS="${CONFIG[${LIST}.subscribers]}"
        DESCRIPTION="${CONFIG[${LIST}.description]}"
        echo >> ${ALIAS_FILE}
        echo "# ${LIST}: ${DESCRIPTION} <${ADDRESS}>" >> ${ALIAS_FILE}
        echo "# ${SUBSCRIBERS}" >> ${ALIAS_FILE}
        echo "${LIST}: |${SCRIPT} ${LIST}" >> ${ALIAS_FILE}
        echo "${LIST}-bounce: ${BOUNCE}" >> ${ALIAS_FILE}

        mkdir -p ${LIB_DIR}/${LIST}/new
        mkdir -p ${LIB_DIR}/${LIST}/archive
    done
    echo
}

# Main entry point
case $1 in
    "setup")
        setup
        ;;
    "")
        echo "Use: $0 setup"
        ;;
    *)
       handle_mail $1
       ;;
esac
