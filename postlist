#!/bin/bash

# TODO: Run with suid and have a list user.
# Examine how mailman3 filtering happend - we are also a filter

set -e
export PATH=${PATH}:/usr/bin:/usr/sbin

### Init file reader
trim()
{
    local trimmed="$@"

    # Strip leading space.
    trimmed="${trimmed## }"
    # Strip trailing space.
    trimmed="${trimmed%% }"

    echo "$trimmed"
}


function parseIniFile() { #accepts the name of the file to parse as argument ($1)
    #declare syntax below (-gA) only works with bash 4.2 and higher
    unset CONFIG
    declare -gA CONFIG
    currentSection=""
    while read -r line; do
        if [[ $line = \[*  ]]; then
            currentSection=$(echo $line | tr -d "[]")
        elif [[ $line = *=*  ]]; then
            key=$(trim $currentSection.$(echo $line | cut -d'=' -f1))
            value="$(trim $(echo $line | cut -d'=' -f2))"
            CONFIG[$key]="$value"
        fi
    done < <(sed 's/#.*//' $1)
}

CONFIG_FILE=${CONFIG_FILE-/etc/postlist.conf}
if [ -f /etc/default/postlist ]; then
    source /etc/default/postlist
fi
echo Parse ${CONFIG_FILE}
parseIniFile ${CONFIG_FILE}

ADMIN="${CONFIG[general.owner]}"
LIB_DIR="${CONFIG[general.archive_dir]}"
ALIAS_FILE="${CONFIG[general.alias_file]}"
DOMAIN="${CONFIG[general.domain]}"

SENDMAIL="/usr/sbin/sendmail -G -i" # NEVER NEVER NEVER use "-t" here.
# Exit codes from <sysexits.h>
EX_TEMPFAIL=75
EX_UNAVAILABLE=69

# Need to handle CC.
function handle_mail () {
    LIST=$1
    ADDRESS=${LIST}@${DOMAIN}
    if [ -z "${ADDRESS}" ]; then
	echo "List does not exist: $LIST"
	exit ${EX_UNAVAILABLE}
    fi
    SUBSCRIBERS="${CONFIG[${LIST}.subscribers]}"
    DESCRIPTION="${CONFIG[${LIST}.description]}"
    BOUNCE=${LIST}-bounce@${DOMAIN}

    # Figure out if we are CC'ed or Addressed directly
    # Its a bit hard, as we might have multiple TO adresses and multiple CC addresses

    ARCHIVE_DIR=${LIB_DIR}/${LIST}
    MAIL=${ARCHIVE_DIR}/new/$(date -Ins)
    cat >${MAIL} || (echo Cannot save mail to file; exit $EX_TEMPFAIL)

    if formail -z -x 'X-Loop:' | grep -q ${LIST}; then
        SUBJECT=$(formail -x Subject: < ${MAIL})
        cat ${MAIL} \
            | formail -t -f \
	              -I "List-Id: ${DESCRIPTION} <$ADDRESS>" \
	              -I "DKIM-Signature:" \
	              -i "Subject:[$LIST Bounce] ${SUBJECT}" \
            | ${SENDMAIL} ${ADMIN}
	mv $MAIL ${ARCHIVE_DIR}/bounce

    else
        SENDER=$(formail -z -x 'From:' < ${MAIL} | sed 's/</(/g' | sed 's/>/)/g')
	#-I "To:${LIST} <${ADDRESS}>" \

        cat ${MAIL} \
            | formail -t -f \
	              -I "Return-Path:" \
	              -i "From: [${LIST}] ${SENDER} <${ADDRESS}>" \
	              -I "X-Loop: ${LIST}" \
                      -I "Message-ID:" -a "Message-ID:" \
	              -I "DKIM-Signature:" \
	              -I "List-Id: ${DESCRIPTION} <${ADDRESS/@/.}>" \
	              -I "List-Post: ${DESCRIPTION} <$ADDRESS>" \
	              -I "List-Unsubscribe: <$ADMIN>" \
	              -I "List-Owner: <$ADMIN>" \
            | ${SENDMAIL} -f ${BOUNCE} ${SUBSCRIBERS}
	mv $MAIL ${ARCHIVE_DIR}/archive
    fi
}

## Setup all lists.

function setup () {
    echo -n "Setup ${ALIAS_FILE} for lists:"
    SCRIPT=$(readlink -f $0)
    # Create all directories, and create the alias file
    LISTS="$(cat $CONFIG_FILE | grep "^\[.*\]" | sed 's/[\[\]]//g' | tr -d "[]" | grep -v 'general')"
    echo "# Autogenerated file. Do not edit" > ${ALIAS_FILE}
    echo "# Generated $(date) by ${SCRIPT}" >> ${ALIAS_FILE}

    for LIST in ${LISTS}; do
        echo -n "$LIST "
	ADDRESS=${LIST}@${DOMAIN}
	SUBSCRIBERS="${CONFIG[${LIST}.subscribers]}"
	DESCRIPTION="${CONFIG[${LIST}.description]}"
        echo >> ${ALIAS_FILE}
        echo "# ${LIST}: ${DESCRIPTION} <${ADDRESS}>" >> ${ALIAS_FILE}
        echo "${LIST}: |${SCRIPT}" >> ${ALIAS_FILE}
        echo "${LIST}-bounce: ${ADMIN}" >> ${ALIAS_FILE}

	for dir in new archive bounce; do
            mkdir -p ${LIB_DIR}/${LIST}/${dir}
	    chmod a+rw ${LIB_DIR}/${LIST}/${dir}
	done
    done
    echo

    postalias ${ALIAS_FILE}
    postfix reload
}

# Main entry point
case $1 in
    "setup")
        setup
        ;;
    *)
	if [ -n "${LOCAL}" ]; then
	    handle_mail ${LOCAL}
	else
            "Use: $0 setup"
	fi
        ;;
esac
